import React, { useEffect, useState } from 'react';

const TelegramUserInfo = () => {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º useState –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–æ–∫
  const [telegramUser, setTelegramUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  useEffect(() => {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const loadTelegramUser = async () => {
      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ –æ–±—ä–µ–∫—Ç Telegram.WebApp –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ window
        // –≠—Ç–æ—Ç –æ–±—ä–µ–∫—Ç –∏–Ω–∂–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è Telegram –∫–ª–∏–µ–Ω—Ç–æ–º, –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Web App
        if (!window.Telegram?.WebApp) {
          setError("Telegram Web App API –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∏–µ–Ω—Ç–∞ Telegram.");
          setLoading(false);
          return;
        }

        const webApp = window.Telegram.WebApp;

        // –£–≤–µ–¥–æ–º–ª—è–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é
        webApp.ready();
        // (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –†–∞—Å—à–∏—Ä—è–µ–º Web App –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω –¥–ª—è –ª—É—á—à–µ–≥–æ UX
        webApp.expand();
        // (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ü–≤–µ—Ç —Ñ–æ–Ω–∞
        // webApp.setBackgroundColor('#17212b');
        // webApp.setHeaderColor('#17212b');


        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
        // webApp.initData - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.
        // webApp.initDataUnsafe - —ç—Ç–æ –ø–∞—Ä—à–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏, –≤–∫–ª—é—á–∞—è 'user'.
        // –í–ù–ò–ú–ê–ù–ò–ï: –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ webApp.initDataUnsafe.user –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ –ù–ï–ë–ï–ó–û–ü–ê–°–ù–û
        // –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏!
        // –í –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ü–µ–ª—è—Ö –º—ã –ø–æ–ª—É—á–∏–º –¥–∞–Ω–Ω—ã–µ –ø—Ä—è–º–æ –æ—Ç—Å—é–¥–∞:
        const user = webApp.initDataUnsafe?.user;

        if (user) {
          // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          setTelegramUser(user);

          // --- –ú–ï–°–¢–û –î–õ–Ø –ë–≠–ö–ï–ù–î –í–ê–õ–ò–î–ê–¶–ò–ò (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –í –ü–†–û–î–ê–ö–®–ï–ù–ï) ---
          // –í–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è 'user' –∑–¥–µ—Å—å, –≤—ã –î–û–õ–ñ–ù–´ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
          // webApp.initData –Ω–∞ –≤–∞—à –±—ç–∫–µ–Ω–¥, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–≥–æ –ø–æ–¥–ø–∏—Å—å —Å —Ç–æ–∫–µ–Ω–æ–º –±–æ—Ç–∞,
          // –∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è,
          // –∫–æ—Ç–æ—Ä—ã–µ –±—ç–∫–µ–Ω–¥ –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –≤ –æ—Ç–≤–µ—Ç.
          //
          // –ü—Ä–∏–º–µ—Ä (–ø—Å–µ–≤–¥–æ–∫–æ–¥):
          // fetch('/api/validate-telegram-data', {
          //   method: 'POST',
          //   headers: { 'Content-Type': 'application/json' },
          //   body: JSON.stringify({ initData: webApp.initData }),
          // })
          // .then(response => response.json())
          // .then(data => {
          //    if (data.isValid) {
          //       setTelegramUser(data.user); // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –±—ç–∫–µ–Ω–¥–æ–º
          //    } else {
          //       setError("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
          //    }
          // })
          // .catch(err => {
          //    console.error("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±—ç–∫–µ–Ω–¥–æ–º:", err);
          //    setError("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
          // });
          // ---------------------------------------------------------------

        } else {
          // –ï—Å–ª–∏ –æ–±—ä–µ–∫—Ç user –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, Web App –æ—Ç–∫—Ä—ã—Ç –Ω–µ –∏–∑ —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º –∏–ª–∏ –∏–∑ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç)
          setError("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ —á–µ—Ä–µ–∑ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Telegram Bot.");
        }

      } catch (err) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª—é–±—ã—Ö –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Telegram Web App:", err);
        setError("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.");
      } finally {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º loading –≤ false –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—É—Å–ø–µ—Ö–∞ –∏–ª–∏ –æ—à–∏–±–∫–∏)
        setLoading(false);
      }
    };

    // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    loadTelegramUser();

  }, []); // –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ useEffect –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞

  // –£—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
  if (loading) {
    return <div style={{ padding: '20px', textAlign: 'center' }}>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram...</div>;
  }

  if (error) {
    return <div style={{ padding: '20px', color: 'red', textAlign: 'center' }}>–û—à–∏–±–∫–∞: {error}</div>;
  }

  if (!telegramUser) {
      // –≠—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ, –µ—Å–ª–∏ loading=false, error=null, –Ω–æ telegramUser —Ç–∞–∫ –∏ –Ω–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
      return <div style={{ padding: '20px', textAlign: 'center' }}>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.</div>;
  }

  // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Ö
  return (
    <div style={{ fontFamily: 'sans-serif', padding: '20px', maxWidth: '500px', margin: 'auto', border: '1px solid #ccc', borderRadius: '8px', boxShadow: '2px 2px 10px rgba(0,0,0,0.1)' }}>
      <h2 style={{ textAlign: 'center', color: '#0088CC' }}>–ü—Ä–∏–≤–µ—Ç, {telegramUser.first_name}! üëã</h2>
      {/* –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ */}
      {telegramUser.photo_url && (
        <img
          src={telegramUser.photo_url}
          alt={`${telegramUser.first_name}'s profile`}
          style={{ display: 'block', margin: '0 auto 20px auto', borderRadius: '50%', width: '100px', height: '100px', objectFit: 'cover' }}
        />
      )}
      {/* –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥—Ä—É–≥–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */}
      <p><strong>ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> {telegramUser.id}</p>
      {telegramUser.username && <p><strong>–ù–∏–∫ (Username):</strong> @{telegramUser.username}</p>}
      {telegramUser.last_name && <p><strong>–§–∞–º–∏–ª–∏—è:</strong> {telegramUser.last_name}</p>}
      {telegramUser.language_code && <p><strong>–Ø–∑—ã–∫:</strong> {telegramUser.language_code}</p>}
      {telegramUser.is_premium && <p>‚ú® **Telegram Premium –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**</p>}
      {/* –ú–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ –æ–±—ä–µ–∫—Ç–µ user –∏ –≤–∞–º –Ω—É–∂–Ω—ã */}

       <p style={{ fontSize: '0.9em', color: '#666', marginTop: '20px' }}>
           <small>–≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Telegram Web App API.
           <br/>
           –î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (initData).</small>
       </p>
    </div>
  );
};

export default TelegramUserInfo;